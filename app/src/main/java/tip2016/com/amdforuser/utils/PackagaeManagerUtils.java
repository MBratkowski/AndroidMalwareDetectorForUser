package tip2016.com.amdforuser.utils;

import android.content.Context;
import android.content.pm.ApplicationInfo;
import android.content.pm.PackageInfo;
import android.content.pm.PackageManager;

import java.util.ArrayList;
import java.util.List;

import rx.Observable;
import rx.Subscriber;
import tip2016.com.amdforuser.data.model.ApplicationsModel;

/**
 * Created by brate on 01.06.2016.
 */
public class PackagaeManagerUtils {
    public static Observable<List<ApplicationsModel>> getApplicationsPermissionsList(final Context mContext) {
        return Observable.create(new Observable.OnSubscribe<List<ApplicationsModel>>() {
            @Override
            public void call(Subscriber<? super List<ApplicationsModel>> subscriber) {
                if (subscriber.isUnsubscribed()) {
                    return;
                }
                if (mContext != null) {
                    final PackageManager mPackageManager = mContext.getPackageManager();
                    final List<ApplicationInfo> installedApps = mPackageManager.getInstalledApplications(PackageManager.GET_META_DATA);
                    final List<ApplicationsModel> mApplication = new ArrayList<>();
                    for (int j = 0; j < installedApps.size(); j++) {
                        try {
                            PackageInfo packageInfo = mPackageManager.getPackageInfo(installedApps.get(j).packageName, PackageManager.GET_PERMISSIONS);
                            ApplicationsModel mAppInfo = new ApplicationsModel(packageInfo.applicationInfo.loadLabel(mContext.getPackageManager()).toString(),
                                    packageInfo.packageName, packageInfo.applicationInfo.loadIcon(mPackageManager));
                            String[] permissionArray = packageInfo.requestedPermissions;
                            if (permissionArray != null) {
                                for (int i = 0; i < permissionArray.length - 1; i++) {
                                    mAppInfo.setKeyValue(permissionArray[i], 1);
                                }
                            }
                            mApplication.add(mAppInfo);
                        } catch (PackageManager.NameNotFoundException e) {
                            subscriber.onError(e);
                        }

                    }
                    if (!subscriber.isUnsubscribed()) {
                        subscriber.onNext(mApplication);
                        subscriber.onCompleted();
                    }
                }
            }
        });
    }
}

