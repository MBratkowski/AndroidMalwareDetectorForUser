package tip2016.com.amdforuser.engine;

/**
 * Created by brate on 01.06.2016.
 */

import java.io.InputStream;
import java.util.ArrayList;

import weka.classifiers.Classifier;
import weka.core.Instances;
import weka.core.converters.ConverterUtils.DataSource;

public class Engine {

    private Instances dataSet = null; //Data to train classifier
    private Classifier model = null; //Classifier
    private Instances classifiedData = null; //Data which will be classified

    //"dataSetFileName" - data set to train classifier, "model" - classifier
    public Engine(InputStream dataSetFileName, Classifier model) throws Exception {

        dataSet = readData(dataSetFileName);
        this.model = model;
        trainClassifier();

    }

    public void setDataSet(Instances dataSet) {
        this.dataSet = dataSet;
    }

    public void setModel(Classifier model) {
        this.model = model;
    }

    public void setClassifiedData(Instances classifiedData) {
        this.classifiedData = classifiedData;
    }

    public Instances getDataSet() {
        return dataSet;
    }

    public Classifier getModel() {
        return model;
    }

    public Instances getClassifiedData() {
        return classifiedData;
    }

    //Method to read data set (used in training classifiers) and to read data to classify (unlabeled) from ARFF/CSV file (ARFF prefered)
    //Returning null if not succeed
    public Instances readData(InputStream dataFileName) {

        Instances readedData = null;

        try {
            DataSource source = new DataSource(dataFileName);
            readedData = source.getDataSet();

            if (readedData.classIndex() == -1)
                readedData.setClassIndex(readedData.numAttributes() - 1);

        } catch (Exception ex) {

        }

        return readedData;

    }

    //Method to train classifier from field "model"
    private void trainClassifier() throws Exception {

        if (dataSet != null) {
            model.buildClassifier(dataSet);
        }

    }

    //Method to classify one or many instances
    //Parameter "unlabeledDataSetFileName" - file name of ARFF file with same header like training data set but with "?" in class column of instances
    //Returning ArrayList<String> with results of classification of all instances from unlabeled data set ("unlabeledDataSetFileName")
    //Returning null if not succeed
    public ArrayList<String> classify(InputStream unlabeledDataSetFileName) throws Exception {

        ArrayList<String> classification_results = null;

        if (classifiedData == null)
            classifiedData = readData(unlabeledDataSetFileName);

        if (dataSet != null && classifiedData != null && model != null) {

            classification_results = new ArrayList<>();

            for (int i = 0; i < classifiedData.numInstances(); i++) {

                double label = model.classifyInstance(classifiedData.instance(i));
                classifiedData.instance(i).setClassValue(label);

                //Current instance class name (String)
                classification_results.add(dataSet.classAttribute().value((int) label));
            }
        }
        return classification_results;

    }

    //Method to classify one or many instances
    //Parameter "unlabeledDataSet" - object of Instances to classify in same form like training data set but with missing values in class column of instances
    //Returning ArrayList<String> with results of classification of all instances from unlabeled data set ("unlabeledDataSetFileName")
    //Returning null if not succeed
    public ArrayList<String> classify(Instances unlabeledDataSet) throws Exception {

        ArrayList<String> classification_results = null;

        if (classifiedData == null) {
            classifiedData = unlabeledDataSet;
            classifiedData.setClassIndex(classifiedData.numAttributes() - 1);
        }


        if (dataSet != null && classifiedData != null && model != null) {

            classification_results = new ArrayList<>();

            for (int i = 0; i < classifiedData.numInstances(); i++) {

                double label = model.classifyInstance(classifiedData.instance(i));
                classifiedData.instance(i).setClassValue(label);

                //Current instance class name (String)
                classification_results.add(dataSet.classAttribute().value((int) label));

            }

        }

        return classification_results;

    }
}
