package tip2016.com.amdforuser.ui.applications.fragment_details;

import java.util.ArrayList;
import java.util.LinkedHashMap;
import java.util.Map;

import tip2016.com.amdforuser.R;
import tip2016.com.amdforuser.common.Constants;
import tip2016.com.amdforuser.data.model.ApplicationsModel;
import tip2016.com.amdforuser.engine.Engine;
import tip2016.com.amdforuser.engine.InstancesObjectCreator;
import tip2016.com.amdforuser.mvp.ApplicationsDetailMvp;
import weka.core.Instances;

/**
 * Created by brate on 02.06.2016.
 */
public class ApplicationsDetailPresenter implements ApplicationsDetailMvp.Presenter {

    private ApplicationsDetailMvp.View mView;
    private Engine mEngine;

    public ApplicationsDetailPresenter(ApplicationsDetailMvp.View mView, Engine mEngine) {
        this.mView = mView;
        this.mEngine = mEngine;
    }


    @Override
    public void scanApplication(ApplicationsModel application) {
        ArrayList<String> classificationResultArrayList = new ArrayList<>();
        Instances mInstances = createInstanceApplicationToTheEngine(createStringPermission(application));
        try {
            classificationResultArrayList = mEngine.classify(mInstances);
        } catch (Exception e) {
            e.printStackTrace();
            mView.showError(R.string.classification_error);
        }
        sendResultToTheVIew(classificationResultArrayList);

    }

    @Override
    public void sendResultToTheVIew(ArrayList<String> classificationResultArrayList) {
        for (String classLabel : classificationResultArrayList) {
            if (classLabel.equals(Constants.SOFTWARE_DETECTED)) {
                mView.resultScan(R.string.result_software, android.R.color.holo_green_dark);
            } else {
                mView.resultScan(R.string.result_malware, android.R.color.holo_red_dark);
            }
        }
    }

    private Instances createInstanceApplicationToTheEngine(String instanceFuel) {
        InstancesObjectCreator mInstancesObjectCreator = new InstancesObjectCreator();
        return mInstancesObjectCreator.createInstancesObject(null, instanceFuel);
    }

    private String createStringPermission(ApplicationsModel application) {
        StringBuilder mStringBuilder = new StringBuilder();
        LinkedHashMap<String, Integer> permissionMap = application.getPermissionsName();
        for (Map.Entry<String, Integer> entry : permissionMap.entrySet()) {
            mStringBuilder.append(String.valueOf(entry.getValue()));
        }
        return mStringBuilder.toString();
    }


}
